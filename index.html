<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹åŠ¿ç²’å­å¤§çˆ†ç‚¸å€’è®¡æ—¶</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Arial', sans-serif; }
        #container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
        
        /* UI ç•Œé¢å±‚ */
        #ui-overlay {
            position: absolute; top: 20px; left: 0; width: 100%;
            text-align: center; pointer-events: none; z-index: 10;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        #status-text { color: #aaa; font-size: 18px; letter-spacing: 2px; margin-bottom: 10px; }
        #target-number { 
            font-size: 120px; font-weight: 900; color: #fff; 
            text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
            transition: all 0.3s ease-out;
        }
        
        /* çˆ†ç‚¸æ—¶çš„é—ªå…‰å±‚ */
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 100;
        }

        /* æ‘„åƒå¤´é¢„è§ˆï¼ˆè°ƒè¯•ç”¨ï¼Œé»˜è®¤éšè—ï¼Œå¯å–æ¶ˆæ³¨é‡ŠæŸ¥çœ‹ï¼‰ */
        #video-input { position: fixed; bottom: 10px; right: 10px; width: 160px; height: 120px; opacity: 0.5; transform: scaleX(-1); z-index: 20; display: none;}
    </style>
</head>
<body>

    <div id="ui-overlay">
        <div id="status-text">ç­‰å¾…æ‰‹åŠ¿ä¿¡å·...</div>
        <div id="target-number">5</div>
    </div>
    <div id="flash-overlay"></div>

    <video id="video-input" playsinline></video>
    <div id="container"></div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        // --- é…ç½®å‚æ•° ---
        const PARTICLE_COUNT = 35000; // ç²’å­æ€»æ•°ï¼Œè¶Šå¤šè¶Šéœ‡æ’¼ï¼Œä½†æ€§èƒ½è¦æ±‚è¶Šé«˜
        const CAMERA_Z = 12; // æ‘„åƒæœºè·ç¦»
        
        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, particleSystem;
        let positions, targetPositions, colors, velocities; // ç²’å­å±æ€§æ•°ç»„
        let gameState = {
            currentStep: 5, // å½“å‰ç­‰å¾…çš„æ•°å­— (5 -> 1)
            isExploding: false, // æ˜¯å¦å¤„äºçˆ†ç‚¸çŠ¶æ€
            lastGestureTime: 0 // ç”¨äºé˜²æ­¢æ‰‹åŠ¿æŠ–åŠ¨é‡å¤è§¦å‘
        };

        const statusTextEl = document.getElementById('status-text');
        const targetNumberEl = document.getElementById('target-number');
        const flashOverlayEl = document.getElementById('flash-overlay');

        // ==========================================
        // 1. Three.js åœºæ™¯åˆå§‹åŒ–
        // ==========================================
        function initScene() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02); // æ·»åŠ ä¸€ç‚¹é›¾æ°”å¢åŠ æ·±é‚ƒæ„Ÿ

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = CAMERA_Z;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('container').appendChild(renderer.domElement);

            // --- åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ ---
            const geometry = new THREE.BufferGeometry();
            positions = new Float32Array(PARTICLE_COUNT * 3);
            targetPositions = new Float32Array(PARTICLE_COUNT * 3); // ç²’å­è¦å»çš„ç›®æ ‡ä½ç½®
            colors = new Float32Array(PARTICLE_COUNT * 3);
            velocities = new Float32Array(PARTICLE_COUNT * 3); // çˆ†ç‚¸æ—¶ç”¨çš„é€Ÿåº¦å‘é‡

            // åˆå§‹çŠ¶æ€ï¼šéšæœºæ•£å¸ƒ
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const i3 = i * 3;
                positions[i3] = (Math.random() - 0.5) * 20;
                positions[i3 + 1] = (Math.random() - 0.5) * 20;
                positions[i3 + 2] = (Math.random() - 0.5) * 20;
                // åˆå§‹åŒ–é¢œè‰²ä¸ºæš—è“è‰²
                colors[i3] = 0.1; colors[i3+1] = 0.3; colors[i3+2] = 0.8;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            // ä½¿ç”¨è‡ªå®šä¹‰æè´¨ç‚¹ï¼Œå¯ç”¨é¡¶ç‚¹é¢œè‰²
            const material = new THREE.PointsMaterial({
                size: 0.05,
                vertexColors: true,
                blending: THREE.AdditiveBlending, // å‘å…‰å åŠ æ•ˆæœ
                transparent: true,
                depthWrite: false
            });

            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);

            // åˆå§‹å½¢æ€ï¼šæ•°å­— 5
            morphToShape(5);
            updateUI(5, "è¯·ä¼¸å‡º 5 ä¸ªæ‰‹æŒ‡å¼€å§‹å€’è®¡æ—¶");

            window.addEventListener('resize', onWindowResize);
        }

        // ==========================================
        // 2. ç²’å­å½¢æ€æ•°å­¦æ¨¡å‹ (æ ¸å¿ƒè§†è§‰æ•ˆæœ)
        // ==========================================
        function morphToShape(number) {
            const pos = targetPositions;
            const col = colors;
            const time = Date.now() * 0.001;

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const i3 = i * 3;
                const p = i / PARTICLE_COUNT; // å½’ä¸€åŒ–ç´¢å¼• 0-1
                let x, y, z, r, g, b;

                switch (number) {
                    case 5: // å·¨å¤§çš„èƒ½é‡ç¯/çƒ
                        statusTextEl.style.color = "#00ffff";
                        targetNumberEl.style.textShadow = "0 0 20px #00ffff";
                        const phi5 = Math.acos(-1 + (2 * i) / PARTICLE_COUNT);
                        const theta5 = Math.sqrt(PARTICLE_COUNT * Math.PI) * phi5;
                        const radius5 = 6 + Math.sin(phi5 * 10 + time)*0.2; // è¡¨é¢å¾®åŠ¨
                        x = radius5 * Math.cos(theta5) * Math.sin(phi5);
                        y = radius5 * Math.sin(theta5) * Math.sin(phi5);
                        z = radius5 * Math.cos(phi5);
                        r=0.1; g=0.8; b=1.0; // é’è“è‰²
                        break;

                    case 4: // ç«‹æ–¹ä½“çŸ©é˜µ
                        statusTextEl.style.color = "#00ff00";
                        targetNumberEl.style.textShadow = "0 0 20px #00ff00";
                        const side = Math.cbrt(PARTICLE_COUNT);
                        const spacing = 6 / side;
                        const ix = i % side;
                        const iy = Math.floor(i / side) % side;
                        const iz = Math.floor(i / (side * side));
                        x = (ix - side / 2) * spacing + (Math.random()-0.5)*0.2;
                        y = (iy - side / 2) * spacing + (Math.random()-0.5)*0.2;
                        z = (iz - side / 2) * spacing + (Math.random()-0.5)*0.2;
                        r=0.2; g=1.0; b=0.2; // ç»¿è‰²
                        break;

                    case 3: // åŒèºæ—‹ DNA
                        statusTextEl.style.color = "#ff00ff";
                        targetNumberEl.style.textShadow = "0 0 20px #ff00ff";
                        const turns = 5;
                        const height = 10;
                        const radius3 = 3;
                        const angle3 = p * Math.PI * 2 * turns;
                        const strand = i % 2 === 0 ? 1 : -1; // ä¸¤æ¡é“¾
                        x = Math.cos(angle3 + strand * Math.PI) * radius3;
                        y = (p - 0.5) * height;
                        z = Math.sin(angle3 + strand * Math.PI) * radius3;
                        r=1.0; g=0.2; b=1.0; // ç´«è‰²
                        break;
                        
                    case 2: // åŒå­æ˜Ÿç¯ç»•
                        statusTextEl.style.color = "#ffaa00";
                        targetNumberEl.style.textShadow = "0 0 20px #ffaa00";
                        const sphereIdx = i % 2 === 0 ? 1 : -1; // åˆ†å±ä¸¤ä¸ªçƒä½“
                        const offset = 3.5;
                        const phi2 = Math.acos(-1 + (2 * (i/2)) / (PARTICLE_COUNT/2));
                        const theta2 = Math.sqrt((PARTICLE_COUNT/2) * Math.PI) * phi2;
                        const r2 = 2;
                        // åŸºç¡€çƒä½“å½¢çŠ¶ + æ•´ä½“ç¯ç»•åç§»
                        x = r2 * Math.cos(theta2) * Math.sin(phi2) + offset * sphereIdx * Math.cos(time);
                        y = r2 * Math.sin(theta2) * Math.sin(phi2);
                        z = r2 * Math.cos(phi2) + offset * sphereIdx * Math.sin(time);
                        r=1.0; g=0.6; b=0.1; // æ©™è‰²
                        break;

                    case 1: // å¥‡ç‚¹ (æåº¦å‹ç¼©)
                        statusTextEl.style.color = "#ff0000";
                        targetNumberEl.style.textShadow = "0 0 30px #ff0000, 0 0 60px #ff0000";
                        // æ‰€æœ‰ç²’å­æŒ¤å‹åˆ°ä¸­å¿ƒï¼Œå¸¦æœ‰å¼ºçƒˆçš„é¢¤æŠ–
                        const shake = 0.3; 
                        x = (Math.random() - 0.5) * shake;
                        y = (Math.random() - 0.5) * shake;
                        z = (Math.random() - 0.5) * shake;
                        // ä¸­å¿ƒäº®ç™½ï¼Œè¾¹ç¼˜çº¢
                        const dist = Math.sqrt(x*x+y*y+z*z);
                        r=1.0; g=1.0-dist*2; b=1.0-dist*2; 
                        break;
                }

                // è®¾ç½®ç›®æ ‡é¢œè‰²
                colors[i3] = r; colors[i3+1] = g; colors[i3+2] = b;
                
                // å¦‚æœä¸æ˜¯çˆ†ç‚¸çŠ¶æ€ï¼Œæ›´æ–°ç›®æ ‡ä½ç½®
                if (!gameState.isExploding) {
                    pos[i3] = x;
                    pos[i3+1] = y;
                    pos[i3+2] = z;
                }
            }
            particleSystem.geometry.attributes.color.needsUpdate = true;
        }

        // ==========================================
        // 3. å¤§çˆ†ç‚¸é€»è¾‘
        // ==========================================
        function triggerBigBang() {
            gameState.isExploding = true;
            updateUI("", "ğŸ’¥ BIG BANG! ğŸ’¥");
            targetNumberEl.style.opacity = 0;

            // 1. å±å¹•é—ªç™½å…‰
            flashOverlayEl.style.opacity = 1;
            setTimeout(() => { flashOverlayEl.style.transition = "opacity 2s"; flashOverlayEl.style.opacity = 0; }, 100);

            // 2. ä¸ºæ‰€æœ‰ç²’å­èµ‹äºˆå‘å¤–çš„çˆ†ç‚¸é€Ÿåº¦
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const i3 = i * 3;
                // é€Ÿåº¦æ–¹å‘ï¼šä»ä¸­å¿ƒå‘å¤–
                const vx = positions[i3] * (Math.random() * 5 + 2); // éšæœºé€Ÿåº¦å¤§å°
                const vy = positions[i3+1] * (Math.random() * 5 + 2);
                const vz = positions[i3+2] * (Math.random() * 5 + 2);
                
                // æ·»åŠ ä¸€äº›éšæœºæ‰°åŠ¨
                velocities[i3] = vx + (Math.random()-0.5)*2;
                velocities[i3+1] = vy + (Math.random()-0.5)*2;
                velocities[i3+2] = vz + (Math.random()-0.5)*2;

                // çˆ†ç‚¸æ—¶é¢œè‰²å˜è¶…äº®ç™½
                colors[i3] = 2.0; colors[i3+1] = 2.0; colors[i3+2] = 2.0;
            }
            particleSystem.geometry.attributes.color.needsUpdate = true;
            // å¢å¤§ç²’å­å°ºå¯¸å¢å¼ºå†²å‡»åŠ›
            particleSystem.material.size = 0.1; 
        }


        // ==========================================
        // 4. æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ (MediaPipe)
        // ==========================================
        const videoElement = document.getElementById('video-input');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

        hands.onResults((results) => {
            if (gameState.isExploding || !results.multiHandLandmarks.length) return;

            const landmarks = results.multiHandLandmarks[0];
            const detectedNumber = countFingers(landmarks);
            const now = Date.now();

            // æ ¸å¿ƒé€»è¾‘ï¼šä¸¥æ ¼é¡ºåºåŒ¹é…
            // åªæœ‰å½“è¯†åˆ«å‡ºçš„æ•°å­— === å½“å‰ç­‰å¾…çš„æ•°å­—ï¼Œå¹¶ä¸”è·ç¦»ä¸Šæ¬¡è§¦å‘è¶…è¿‡500ms(é˜²æŠ–)
            if (detectedNumber === gameState.currentStep && (now - gameState.lastGestureTime > 500)) {
                gameState.lastGestureTime = now;