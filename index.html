<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 粒子手势控制</title>
    <style>
        body { margin: 0; background: #000; color: #d4af37; overflow: hidden; font-family: -apple-system, sans-serif; }
        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; pointer-events: none;
        }
        #btn-start {
            padding: 15px 40px; font-size: 20px; background: #d4af37; color: #000;
            border: none; border-radius: 30px; cursor: pointer; pointer-events: auto;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }
        #msg { margin-top: 20px; font-size: 14px; color: #fff; text-align: center; padding: 0 20px; }
        #video-preview { 
            position: absolute; bottom: 10px; right: 10px; width: 100px; height: 75px; 
            border: 1px solid #d4af37; border-radius: 5px; transform: scaleX(-1); z-index: 50;
            background: #111;
        }
    </style>
</head>
<body>

    <div id="container"></div>
    <div id="ui-layer">
        <button id="btn-start">点击开启魔法</button>
        <div id="msg">提示：必须使用 HTTPS 并允许摄像头权限</div>
    </div>
    <video id="video-preview" playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const btn = document.getElementById('btn-start');
        const msg = document.getElementById('msg');
        const video = document.getElementById('video-preview');
        let hands, cameraHelper;

        // 按钮点击后才触发音视频流（移动端浏览器合规要求）
        btn.onclick = async () => {
            btn.style.display = 'none';
            msg.innerText = "正在呼叫摄像头...";
            initAI();
        };

        async function initAI() {
            try {
                // 1. 初始化 Three.js 场景
                const scene = new THREE.Scene();
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // 限制像素比提升性能
                document.getElementById('container').appendChild(renderer.domElement);

                const cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                cam.position.z = 5;

                const points = new THREE.Points(
                    new THREE.SphereGeometry(2, 32, 32),
                    new THREE.PointsMaterial({ size: 0.03, color: 0xd4af37, transparent: true })
                );
                scene.add(points);

                // 2. 配置 MediaPipe Hands
                hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });

                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 0, // 手机端设为0（快速模式）
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults((results) => {
                    msg.style.display = 'none';
                    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        const hand = results.multiHandLandmarks[0][8]; // 食指尖
                        points.rotation.y = (hand.x - 0.5) * 5;
                        points.rotation.x = (hand.y - 0.5) * 5;
                    }
                });

                // 3. 启动摄像头
                cameraHelper = new Camera(video, {
                    onFrame: async () => { await hands.send({ image: video }); },
                    width: 480, height: 360
                });

                await cameraHelper.start();
                msg.innerText = "运行中！请伸出手掌";

                function animate() {
                    requestAnimationFrame(animate);
                    points.rotation.z += 0.005;
                    renderer.render(scene, cam);
                }
                animate();

            } catch (e) {
                msg.innerHTML = `<span style="color:red">启动失败: ${e.message}</span><br>请检查是否被系统拦截或浏览器不支持 WebGL。`;
                console.error(e);
            }
        }

        // 适配屏幕旋转
        window.addEventListener('resize', () => {
            if (cameraHelper) {
                const width = window.innerWidth;
                const height = window.innerHeight;
                // 重新计算 Three.js 尺寸
            }
        });
    </script>
</body>
</html>